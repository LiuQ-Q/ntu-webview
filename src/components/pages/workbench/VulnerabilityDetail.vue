<template>
	<b-container>
		<div class="mb-5">
			<h1>漏洞详情</h1>
		</div>

		<b-table
			:fields="[
				{ key: 'problem', label: '问题' },
				{ key: 'deal', label: '对此问题的处理' },
			]" 
			:items="[{}]"
			class="vulnerability-detail-overview"
		>
			<template 
				slot="problem"
				v-if="issuesById['security_issue'] !== undefined"
			>
				<a 
					target="_blank"
					:href="`https://nvd.nist.gov/vuln/detail/${issuesById['security_issue']['public_id']}`"
				>{{ issuesById['security_issue']['public_id'] }}</a>
				<p>
					<small>{{ issuesById['security_issue']['description'] }}</small>
				</p>

				<b-table
					:fields="[
						{ key: 'first', label: '详情:' },
						{ key: 'second', label: '' },
					]"
					:items="[{}]"
					class="detail-overview-desc"
					borderless
				>
					<template
						slot="first"
					>
						<p>起源:&nbsp;{{ issuesById['library_name'] }}</p>
						<p>版本:&nbsp;{{ issuesById['library_version'] }}</p>
						<p>分数:&nbsp;{{ issuesById['security_issue'].score }}</p>          
					</template>

					<template
						slot="second"
					>
						<p>发现在:&nbsp;{{ issuesById['issue_type'] }}</p>
						<p>补丁版本:&nbsp;{{ issuesById['fixed_library_version'] }}</p>          
						<p>严重性:&nbsp;{{ severity[issuesById['security_issue'].severity] }}</p>          
					</template>
				</b-table>
			</template>

			<template slot="deal">
				<div v-if="issuesById['visibility'] !== 'suppressed'">
					<p class="mb-2">状态:</p>
					<b-form-select
						v-model="priority"
						size='sm'
						class="mb-2"
					>
						<option value="none">未设置</option>
						<option value="high">高</option>
						<option value="medium">中</option>
						<option value="low">低</option>
					</b-form-select>

					<p class="mb-2">优先级:</p>
					<b-form-select
						v-model="actionType"
						size='sm'
						class="mb-2"
					>
						<option value="none">未设置</option>
						<option value="ignored">忽略</option>
						<option value="to_be_fixed">待修复</option>
						<option value="fixed">已修复</option>
					</b-form-select>

					<p class="mb-2">负责人:</p>
					<b-form-select
						v-model="assignee"
						size='sm'
						class="mb-2"
					>
						<option value="none">未设置</option>
						<option 
							v-for="(member, index) in orgsMember"
							:key="index"
							:value="member.user.username"
						>{{ member.user.username }}</option>
					</b-form-select>

					<p>评价:</p>
					<b-form-textarea
						v-model="comment"
						placeholder="请添加评价..."
						rows="3"
						max-rows="6"
						class="mb-3"
					></b-form-textarea>

					<b-button 
						style="float:left;"
						@click="submit"
					>提交</b-button>
				</div>

				<div 
					v-if="issuesById['visibility'] === 'suppressed'"
					class="mb-3"
				>此问题已被压制</div>

				<b-dropdown text="操作" style="float:left;" class="ml-3">
					<b-dropdown-item
						v-if="issuesById['visibility'] !== 'suppressed'"
						@click="suppress"
					>压制此问题</b-dropdown-item>
					<b-dropdown-item
						v-if="issuesById['visibility'] === 'suppressed'"
						@click="unSuppress"
					>解除压制</b-dropdown-item>
					<!-- <b-dropdown-item>创建JIRA门票</b-dropdown-item> -->
				</b-dropdown>
			</template>
		</b-table>

		<b-table
			v-if="hunkList.length !== 0"
			:fields="[
				{ key: 'attacked', label: '受攻击片段' },
				{ key: 'patch', label: '补丁片段' },
			]" 
			:items="hunkList"
			class="attacked-code"
		>
			<template slot="thead-top">
				<tr>
					<th>
						<h5>受攻击代码片段</h5>
					</th>
					<th colspan="2"></th>
				</tr>  
			</template>

			<template
				slot="attacked"
				slot-scope="data"
			>
				<b-form-textarea
					rows=10
					:value="data.item['vulnerable_code']"
				></b-form-textarea>
			</template>

			<template
				slot="patch"
				slot-scope="data"
			>
				<b-form-textarea
					rows=10
					:value="data.item['patch_hunk']['hunk_code']"
				></b-form-textarea>
			</template>
		</b-table>
	</b-container>
</template>

<script>
export default {
	data() {
		return {
			actionType: '',
			priority: '',
			assignee: '',
			comment: '',
			issueType: '',

			orgId: this.$route.params.orgId,
			projectId: this.$route.params.projectId,
			scanId: this.$route.params.scanId,
			issueId: this.$route.params.issueId,
			hunkList: [],
			issuesById: {}, // issue 信息
			orgsMember: [],
			projectById: {},
			severity: {
				Critical: '超高风险',
				High: '高风险',
				Medium: '中等风险',
				Low: '低风险',
			}
		};
	},
	mounted() {
		this.getHunkList();
		this.getIssuesById();
		this.getOrgsMember();
		this.getIssuesLastAction();
		this.getProjectById();
	},
	methods: {
		async getHunkList() {
			this.hunkList = (await this.$backend.issues.hunks.getList(this.issueId)).results;
		},
		async getIssuesById() {
			// issue 信息
			this.issuesById = await this.$backend.issues.getById(this.issueId);
			// console.log(this.issuesById);
			
		},
		async getOrgsMember() {
			this.orgsMember = (await this.$backend.orgs.members.getList(this.orgId)).results;
		},
		async getIssuesLastAction() {
			// 问题处理相关
			this.$backend.issues.lastAction.getList(this.issueId).then(res => {
				if (JSON.stringify(res) === '{}') {
					this.actionType = 'none';
					this.priority = 'none';
					this.assignee = 'none';
					this.issueType = 'vulnerability';
				} else {
					this.actionType = res['action_type'];
					this.priority = res['priority'];
					this.assignee = res['assignee'];
					this.comment = res['comment'];
					this.issueType = res['issue_type'];
				}
			});
		},
		async getProjectById() {
			this.projectById = await this.$backend.projects.getById(this.projectId);
			// console.log(this.projectById);
		},
		submit() {
			this.$backend.scans.actions.create(this.scanId, this.issueId, this.issueType, this.priority, this.actionType, this.assignee, this.comment).then(res => {
				this.$bvToast.toast('提交成功', {
					title: null,
					variant: 'primary',
					toaster: 'b-toaster-top-center',
					autoHideDelay: 2000,
					noCloseButton: true,
					solid: true
				});
			}, error => {
				console.log(error);
				this.$bvToast.toast('提交失败', {
					title: null,
					variant: 'danger',
					toaster: 'b-toaster-top-center',
					autoHideDelay: 2000,
					noCloseButton: true,
					solid: true
				});
			});
		},
		suppress() {
			this.$backend.scans.issues.updateByIdMode(this.scanId, this.issueId, 'suppress').then(res => {
				this.$router.go(0);
			});
		},
		unSuppress() {
			this.$backend.scans.issues.updateByIdMode(this.scanId, this.issueId, 'unsuppress').then(res => {
				this.$router.go(0);
			});
		}
	}
};
</script>

<style lang='less'>
.vulnerability-detail-overview {
	td:nth-child(1) {
		width: 60%;
	}

	.detail-overview-desc {
		// width: 80%;
		td {
			width: 33.33%;
		}
	}
}
.attacked-code {
	td {
		width: 50%;
	}
}
</style>
