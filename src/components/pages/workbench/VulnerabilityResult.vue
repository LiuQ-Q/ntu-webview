<template>
	<b-container>
		<div class="mb-5">
			<h1>漏洞扫描结果</h1>
		</div>

		<b-table
			:fields="[
				{ key: 'mark', label: '标识' },
				{ key: 'library_name', label: '组件' },
				{ key: 'module_name', label: '模组' },
				{ key: 'library_version', label: '版本' },
				{ key: 'issue_type', label: '问题类型' },
				{ key: 'source_type', label: '问题来源' },
				{ key: 'score', label: '综合打分' },
				{ key: 'detail', label: '详情' },
			]"
			:items="scansIssues"
			class="vul-result text-center"
			id="vul-result-table"
			:per-page="vulPerPage"
			:current-page="vulCurrentPage"
		>
			<template slot="thead-top">
				<tr>
					<th>
						<h5>问题列表</h5>
					</th>
					<th>
						<b-button
							size="sm"
							v-if="scansById['vul_report_status'] === 'Available'"
							@click="downloadRepo"
						>下载</b-button>
						<b-button
							size="sm"
							v-if="scansById['vul_report_status'] === 'N.A.'"
							@click="exportRepo"
						>导出</b-button>
						<b-button
							size="sm"
							v-if="scansById['vul_report_status'] === 'Generating'"
							disabled
						>导出中</b-button>
					</th>
					<th colspan="7">&nbsp;</th>
				</tr>  
			</template>

			<template 
				slot="mark" 
				slot-scope="data"
			>{{ data.item['security_issue']['public_id'] }}</template>

			<template 
				slot="score" 
				slot-scope="data"
			>{{ data.item['security_issue'].score }}</template>

			<template 
				slot="detail"
				slot-scope="data"
			>
				<b-link :to="`${scanId}/issue/${data.item.id}`">查看</b-link>
			</template>
		</b-table>
		<b-pagination
			v-model="vulCurrentPage"
			:total-rows="vulRows"
			:per-page="vulPerPage"
			aria-controls="vul-result-table"
			align="center"
			size="sm"
		></b-pagination>
	</b-container>
</template>

<script>
// import b64toBlob from 'b64-to-blob';

export default {
	data() {
		return {
			vulChecked: [],

			orgId: this.$route.params.orgId,
			projectId: this.$route.params.projectId,
			scanId: this.$route.params.scanId,
			scansIssues: [],
			scansById: {},
			vulCurrentPage: 1,
			vulPerPage: 15,
		};
	},
	mounted() {
		this.getScansIssues();
		this.getScansById();
	},
	computed: {
		vulRows() {
			return this.scansIssues.length;
		}
	},
	methods: {
		async getScansIssues() {
			this.scansIssues = (await this.$backend.scans.issues.getList(this.scanId)).results;
		},
		getScansById() {
			// 扫描详细信息
			this.$backend.scans.getById(this.scanId).then(res => {
				this.scansById = res;
				// console.log(res);
				if (res['vul_report_status'] === 'Generating') {
					this.getScansById();
				}
				
			});
		},
		downloadRepo() {
			this.$backend.export.issues.download(this.scanId);
		},
		exportRepo() {
			this.$backend.export.issues.export(this.scanId);
			this.getScansById();   
		},
	}
};
</script>

<style lang="less">
.vul-result {
	td:nth-child(1) {
		width: 15%;
	}
	td:nth-child(3) {
		width: 10%;
	}
}
</style>
