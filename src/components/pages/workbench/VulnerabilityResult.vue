<template>
  <b-container>
    <div class="mb-5">
      <h1>漏洞扫描结果</h1>
    </div>

    <b-table
      :fields="[
        { key: 'mark', label: '标识' },
        { key: 'library_name', label: '组件' },
        { key: 'module_name', label: '模组' },
        { key: 'library_version', label: '版本' },
        { key: 'issue_type', label: '问题类型' },
        { key: 'source_type', label: '问题来源' },
        { key: 'score', label: '综合打分' },
        { key: 'detail', label: '详情' },
        { key: 'check', label: '选择' },
      ]"
      :items="scansIssues"
      class="vul-result text-center"
    >
      <template slot="thead-top">
        <tr>
          <th>
            <h5>问题列表</h5>
          </th>
          <th>
            <b-button
              size="sm"
              v-if="scansById['vul_report_status'] !== 'N.A.'"
              @click="downloadRepo"
            >下载</b-button>
            <b-button
              size="sm"
              v-if="scansById['vul_report_status'] === 'N.A.'"
              @click="exportRepo"
            >导出</b-button>
          </th>
          <th colspan="7">&nbsp;</th>
        </tr>  
      </template>

      <template 
        slot="mark" 
        slot-scope="data"
      >{{ data.item['security_issue']['public_id'] }}</template>

      <template 
        slot="score" 
        slot-scope="data"
      >{{ data.item['security_issue'].score }}</template>

      <template 
        slot="detail"
        slot-scope="data"
      >
        <b-link :to="`${scanId}/issue/${data.item.id}`">查看</b-link>
      </template>

      <template slot="check" slot-scope="data">
        <b-checkbox 
          v-model="vulChecked"
          :value="data.item.id"
        ></b-checkbox>
      </template>
    </b-table>
  </b-container>
</template>

<script>
export default {
  data() {
    return {
      vulChecked: [],

      orgId: this.$route.params.orgId,
      projectId: this.$route.params.projectId,
      scanId: this.$route.params.scanId,
      scansIssues: [],
      scansById: {}
    }
  },
  mounted() {
    this.getScansIssues();
    this.getScansById();
  },
  methods: {
    async getScansIssues() {
      this.scansIssues = (await this.$backend.scans.issues.getList(this.scanId)).results;
    },
    getScansById() {
      // 扫描详细信息
      this.$backend.scans.getById(this.scanId).then(res => {
        this.scansById = res;
      });
    },
    downloadRepo() {
      this.$backend.export.issues.download(this.scanId).then(res => {
        console.log(res);
        
      });

    },
    exportRepo() {
      this.$backend.export.issues.export(this.scanId);
      this.getScansById();   
    },
  }
}
</script>

<style lang="less">
.vul-result {
  td:nth-child(1) {
    width: 15%;
  }
  td:nth-child(3) {
    width: 10%;
  }
}
</style>
